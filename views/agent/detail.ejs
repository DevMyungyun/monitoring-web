<main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><%=rows.name %> Detail</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
      <div class="btn-group mr-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="Handshake"
          onclick="handshakeAgent();">Handshake</button>
        <input type="button" class="btn btn-sm btn-outline-secondary" id="active" value="On" onclick="activeAgent();" />
        <!-- <input type="button" class="btn btn-sm btn-outline-secondary" id="inactive" value="Off" onclick="inactiveAgent();" /> -->
      </div>
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
          Dropdown button
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <a class="dropdown-item" href="#">Action</a>
          <a class="dropdown-item" href="#">Another action</a>
          <a class="dropdown-item" href="#">Something else here</a>
        </div>
      </div>
      <!-- <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
        <span data-feather="calendar"></span>
        This week
      </button> -->
    </div>
  </div>
  <canvas class="my-4 w-100" id="myChart" width="900" height="380"></canvas>

  <div class="col-md-8 order-md-1" style="margin-left: 100px;">
    <!-- <form class="form-signin" action="/agent" method="POST">
        <input type="hidden" name="_method" value="put" /> -->
    <input type="hidden" name="name" class="form-control" id="name" value="<%=rows.name %>">
    <div class="mb-3">
      <label for="status">Status</label>
      <div class="input-group">
        <input type="text" name="status" class="form-control" id="status" value="<%=rows.status %>" disabled>
      </div>
    </div>
    <div class="mb-3">
      <label for="description">Description</label>
      <div class="input-group">
        <input type="text" name="description" class="form-control" id="description" value="<%=rows.description %>">
      </div>
    </div>
    <div class="mb-3">
      <label for="os">OS</label>
      <input type="os" name="os" class="form-control" id="os" value="<%=rows.os %>" required>
      <div class="invalid-feedback">
        Please enter what kind of OS.
      </div>
    </div>
    <div class="mb-3">
      <label for="version">OS Version</label>
      <input type="version" name="version" class="form-control" id="version" value="<%=rows.version %>" required>
      <div class="invalid-feedback">
        Please enter what kind of OS version.
      </div>
    </div>
    <div class="mb-3">
      <label for="address">Address</label>
      <input type="address" name="address" class="form-control" id="address" value="<%=rows.address %>" required>
      <div class="invalid-feedback">
        Please enter the agent address.
      </div>
    </div>
    <div class="mb-3">
      <label for="create_at">Create Time</label>
      <input type="create_at" name="create_at" class="form-control" id="create_at" value="<%=rows.create_at %>" disabled>
    </div>
    <div class="mb-3">
      <label for="update_at">Update Time</label>
      <input type="update_at" name="update_at" class="form-control" id="update_at" value="<%=rows.update_at %>" disabled>
    </div>
    <button class="btn btn-primary" id="update" type="button" onclick="updateBtn();">Update</button>
    <button class="btn btn-danger" id="delete" type="button" onclick="deleteBtn();">Delete</button>
    </form>
  </div>
</main>
<script src="/chart/Chart.js"></script>
<!-- <link rel="stylesheet" type="text/css" href="/chart/Chart.min.css"> -->
<script>
  window.addEventListener('DOMContentLoaded', function()  {
    let query = '?name='+"<%= rows.name %>"
    var xhr = requestSend('get','/agent/healthcheck',query)
    // xhr.onprogress = function () {
    //     console.log('LOADING: ', xhr.status);
    // };
    // xhr.onload = function () {
    //     console.log('DONE: ', xhr.status);
    // };
    xhr.onreadystatechange = function (e) {
      const res = JSON.parse(xhr.response)
      if (res.code === "200" || res.code == "201") {
        // alert('Successfully the agent health check')
        console.log('Successfully the agent health check');
        // location.reload(true)
      } else if(res.code ==="500") {
        alert("Fail to health check. Check the agent status.");
        // location.reload(true)
      } else {
        alert("Unexpected error");
      }
    }

    var status = document.getElementById('status').value;
    var handshakeBtn = document.getElementById('Handshake');
    if(status === 'stop') {
      handshakeBtn.disabled = 'disabled';
      document.getElementById('active').value = "On";
    } else if(status === 'running') {
      handshakeBtn.disabled = 'disabled';
      document.getElementById('active').value = "Off";
    } else {
      handshakeBtn.disabled = false;
    }
  });

  var data = <%- context %>;
  var ctx = document.getElementById('myChart');
  var myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.saved_at,
      datasets: [{
          label: 'CPU',
          data: data.cpu,
          borderColor: "rgba(54, 162, 235, 1)",
          backgroundColor: "rgba(54, 162, 235, 0.5)",
          fill: true,
          lineTension: 0
        },
        {
          label: 'Memory',
          data: data.mem,
          borderColor: "rgba(153, 102, 255, 1)",
          backgroundColor: "rgba(153, 102, 255, 0.5)",
          fill: true,
          lineTension: 0
        },
        {
          label: 'Disk',
          data: data.disk,
          borderColor: "rgba(255, 159, 64, 1)",
          backgroundColor: "rgba(255, 159, 64, 0.5)",
          fill: true,
          lineTension: 0
        }
      ]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Resource Status'
      },
      tooltips: {
        mode: 'index',
        intersect: false,
      },
      hover: {
        mode: 'nearest',
        intersect: true
      },
      scales: {
        xAxes: [{
          display: true,
          scaleLabel: {
            display: true,
            labelString: 'Time'
          }
        }],
        yAxes: [{
          display: true,
          ticks: {
            suggestedMin: 0,
          },
          scaleLabel: {
            display: true,
            labelString: 'Resource Usage{%)'
          }
        }]
      }
    }
  });

  function deleteBtn() {
    if (confirm("Are you sure of delete this agent?")) {
      let query = '?name='+"<%= rows.name %>"
      var xhr = requestSend('delete','/agent',query)
      // xhr.onprogress = function () {
      //     console.log('LOADING: ', xhr.status);
      // };
      // xhr.onload = function () {
      //     console.log('DONE: ', xhr.status);
      // };
      xhr.onreadystatechange = function (e) {
        const res = JSON.parse(xhr.response)
        if (res.code === "200" || res.code == "201") {
          alert('Successfully delete the agent')
          window.location.href = '/agent/main';
        } else {
          alert("Unexpected error");
        }
      }
    } else {
      console.log('Cancel delete this agent.');
    }
  }

  function updateBtn() {
    if (confirm("Are you sure of update this agent?")) {
      let body = {}
      body.description = document.getElementById('description').value
      body.os = document.getElementById('os').value
      body.version = document.getElementById('version').value
      body.address = document.getElementById('address').value

      let query = '?name='+"<%= rows.name %>"
      var xhr = requestSend('put','/agent',query,body)
      // xhr.onprogress = function () {
      //     console.log('LOADING: ', xhr.status);
      // };
      // xhr.onload = function () {
      //     console.log('DONE: ', xhr.status);
      // };
      xhr.onreadystatechange = function (e) {
        const res = JSON.parse(xhr.response)
        if (res.code === "200" || res.code == "201") {
          alert('Successfully update the agent')
          window.location.href = '/agent/main';
        } else {
          alert("Unexpected error");
        }
      }
    } else {
      console.log('Cancel delete this agent.');
    }
  }

  function handshakeAgent() {
    let query = '?name='+"<%= rows.name %>"
    var xhr = requestSend('get','/agent/handshake',query)
    // xhr.onprogress = function () {
    //     console.log('LOADING: ', xhr.status);
    // };
    // xhr.onload = function () {
    //     console.log('DONE: ', xhr.status);
    // };
    xhr.onreadystatechange = function (e) {
      const res = JSON.parse(xhr.response)
      if (res.code === "200" || res.code == "201") {
        alert('Successfully handshake with '+"<%= rows.name %>"+' agent')
        location.reload(true);
        // window.location.href = '/agent/main';
      } else {
        alert("Unexpected error");
      }
    }
  }

  function activeAgent() {
    let activeBtn = document.getElementById('active').value
    let query = '?name='+"<%= rows.name %>"
    if(activeBtn === 'On') {
      var xhr = requestSend('post','/agent/cron/start',query)
      // xhr.onprogress = function () {
      //     console.log('LOADING: ', xhr.status);
      // };
      // xhr.onload = function () {
      //     console.log('DONE: ', xhr.status);
      // };
      xhr.onreadystatechange = function (e) {
        const res = JSON.parse(xhr.response)
        if (res.code === "200" || res.code == "201") {
          alert('Successfully '+"<%= rows.name %>"+' agent cron start')
          location.reload(true);
        } else {
          alert("Unexpected error");
        }
      }
    } else {
      var xhr = requestSend('get','/agent/cron/stop',query)
      // xhr.onprogress = function () {
      //     console.log('LOADING: ', xhr.status);
      // };
      // xhr.onload = function () {
      //     console.log('DONE: ', xhr.status);
      // };
      xhr.onreadystatechange = function (e) {
        const res = JSON.parse(xhr.response)
        if (res.code === "200" || res.code == "201") {
          alert('Successfully '+"<%= rows.name %>"+' agent cron stop')
          location.reload(true);
        } else {
          alert("Unexpected error");
        }
      }
    }
    
  }

  function requestSend(method, url, query, body) {
    var xhr;
    if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
      xhr = new XMLHttpRequest();
    } else { // code for IE6, IE5
      xhr = new ActiveXObject("Microsoft.XMLHTTP");
    }
    xhr.open(method, url+query, true);
    xhr.setRequestHeader("Content-Type", "application/json")
    if (body) {
      var jsonBody = JSON.stringify(body)
      try {
        xhr.send(jsonBody);
      } catch (e) {
        console.log(e);
      }
    } else {
      try {
        xhr.send();
      } catch (e) {
        console.log(e);
      }
    }
    return xhr
  }
</script>